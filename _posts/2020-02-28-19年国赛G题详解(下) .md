---
layout:     post
title:      19年国赛G题详解（下）
subtitle:   双路语音调频收发机 之 接收机
date:       2020-02-28
author:     Sterben
header-img: img/post-bg-3.jpg
catalog: true
tags:
    - FPGA项目
---
## 前言不多说上代码

[Two-way-voice-receiver](https://github.com/Bestduan/Two-way-voice-receiver)

## 方案阐述

和发射机一样接收机的设计也是数模混合实现的所以接收机设计的讲解还是数模分开来讲。在这里我先简单讲一下接收机的原理和整体方案。从天线接收到的信号后，送到射频运放进行40db的两级放大，可以的话建议选择LNA,将放大后的信号下变频，混频到10.7M，之后使用陶瓷滤波器将10.7M的中频滤出来。接下来就是模数变换了，由前面的发射端可知，这时一个调频信号信息都被调制到频率上了，所以在接收端可以和发射端一样进行1bit量化，简单来说就是通过比较器比成脉冲，通过FPGA的IO进行采样。

接下来就是FPGA内部的信号解调了，FPGA要完成的就是FM的解调和AM的解调。在这里之所以选择全部在FPGA里处理是因为数字滤波器的易实现，这里也就是这道题的另外一个难点，由于在发射端进行调制的时候AM的调制信号和另一路音频信号频率很接近，要想较为干净的分离两个信号就需要很陡的滤波器，这在模拟设计上是很难实现的，但是在数字端，使用合适的采样率却很容易实现，同时性能稳定，不容易收到环境温度等因素变化。其中FM和AM的解调方式均采用IQ解调的方式。最后使用PWM调制的方式对解调出来的音频信号进行输出。

流程图如下：

![screenShot.png](https://i.loli.net/2021/03/19/UWj1km7GMeRYftA.png)

----

## 详细说明

### 模拟部分设计

该部分讲解了所有的模拟部分的设计，包含射频前端，混频，比较器(1bitADC)，脉宽调制DAC(PWM DAC)

----

#### 模拟前端设计所需的仪器

200M带宽以上的示波器

频谱分析仪

200M以上的信号发生器

----
#### 射频前端

接收机的前端设计没有发射机那么麻烦，因为不需要做阻抗匹配，前端射频放大我选择的是ADL5536，毕竟是一起买的，电路图直接参照他的数据手册即可
![ADL5536](https://i.loli.net/2020/02/29/L5n7BK1JXHl9wfM.png)。
画板时两级串联。

#### 混频部分

接下来就是混频器的设计，对于混频器的选择我建议使用无源混频器，因为使用简单。这里我选择的是ADE-1，他的参数很适合这个频段。对于本振有条件的可以选择ADF4351,不过对于我来说，我是属于那种没条件的，所以本振的输出就选用了FPGA的IO口自己出一个。（注：FPGA输出的脉冲是直流耦合信号，建议在输入到ADE-1之前加一个10nf的电容滤除直流）混频在之后就要将10.7M的中频信号滤出来。这里选用10.7M作为中频是因为10.7M是特殊频点，淘宝上有专门的陶瓷滤波器。这里我选用的是SFECV10M7CQ0C01-R0。效果还不错，唯一的缺点就是插损比较大。

![screenShot.png](https://i.loli.net/2021/03/19/V9l7pib5EPqrzmh.png)

#### 比较器(1bitADC)

按理说过陶瓷滤波器之后就可以直接过比较器了，但是输入信号太小，阈值比较器比出来不太稳定，所以我在输入到比较器之间加了一个放大器，放大倍数参照实际情况。至于选型，比较器我选择的是TLV3501,放大器我选择的是THS3901。在设计比较器时要注意电源的设计，TLV3501比较器是至轨输出考虑到FPGA的io脚最大所能承受的电压，比较器需要3.3V的供电。

电路图设计如下：
![screenShot.png](https://i.loli.net/2021/03/19/Bm542KqaiMrA8tk.png)

#### 脉宽调制DAC(PWM DAC)

最后要进行音频的输出，最好选用声卡，位数高，其他的音频DAC也可以。但是使用芯片是一件很烦的事情，硬件上要查手册，软件上要写驱动，因此我选择还是使用FPGA的IO口来输出音频信号。具体方法就是脉宽调制，因为在FPGA里进行脉宽调制是一件很简单事情，只需要一个相位累加器即可。

接下来就是怎么将一个脉冲波转化成所要的音频信号。PWM本质上其实就是是一种周期一定，而高低电平占空比可调的方波。实际电路的典型PWM波形如图：![screenShot.png](https://i.loli.net/2020/02/29/xDdZB3mjl6hvwzT.png)

其中：T 是单片机中计数脉冲的基本周期。N 是 PWM 波一个周期的计数脉冲个数。n 是 PWM 波一个周期中高电平的计数脉冲个数。VH 和 VL 分别 是 PWM 波的高低电平电压值，k 为谐波次数，t 为时间。我们将①式展开成傅里叶级数， 得到公式②：![screenShot.png](https://i.loli.net/2020/02/29/9dkFLAKWsUl5oiS.png)

从②式可以看出，式中第 1 个方括弧为直流分量，第 2 项为 1 次谐波分量，第 3 项为大 于 1 次的高次谐波分量。式②中的直流分量与 n 成线性关系，并随着 n 从 0 到 N，直流分量 从 VL 到 VL+VH 之间变化。这正是电压输出的 DAC 所需要的。因此，如果能把式②中除 直流分量外的谐波过滤掉，则可以得到从 PWM 波到电压输出 DAC 的转换，即：PWM 波 可以通过一个低通滤波器进行解调。式②中的第2项的幅度和相角与n有关，频率为1/ （NT）， 其实就是 PWM 的输出频率。该频率是设计低通滤波器的依据。如果能把 1 次谐波很好过滤 掉，则高次谐波就应该基本不存在了。  通过上面的了解，我们可以得到 PWM DAC 的分辨率，计算公式如下：

                                        分辨率=log2（N）  

这里假设 n 的最小变化为 1，当 N=256 的时候，分辨率就是 8 位。 在 8 位分辨条件下，我们一般要求 1 次谐波对输出电压的影响不要超过 1 个位的精度， 也就是 3.3/256=0.01289V。假设 VH 为 3.3V，VL 为 0V，那么一次谐波的最大值是 2*3.3/ π=2.1V，这就要求我们的 RC 滤波电路提供至少-20lg(2.1/0.01289)=-44dB 的衰减。


----

### FPGA设计

#### FM以及AM的解调设计

在这里FM和AM均使用的是IQ相干解调，使用的是基于cordic算法下的正交解调，只要实现cordic算法便可轻松实现`arctan(Q/I)`以及`求解IQ两路信号的模值`**(刚好完成了AM的解调，无须外部再自乘进行平方和计算，cordic算法直接实现三个计算步骤)**，相比于其他FM解调算法更加方便，同时也满足处理中频信号的计算速率。


几种 FM 数字解调算法比较（框图对比）
![screenShot.png](https://i.loli.net/2021/03/19/NdAc7xr4fFMl3S1.png)
![screenShot.png](https://i.loli.net/2021/03/19/83O5C4IXjlWoPFb.png)
![screenShot.png](https://i.loli.net/2021/03/19/W8Ow146RaY59mqh.png)

于是选好解调方案之后，在FPGA工程中完成解调只需要三个功能模块
1. cordic.v         (实现VECTOR模式下的arctan(Q/I)以及(I^2 + Q^2)的开根，以及ROTATE模式下的IQ输出)
2. IQ_Mixed.v       (完成数字下变频分成IQ两路信号)
3. Demodulate.v     (完成下变频后分成IQ两路信号的解调功能的实现)
【注】：cordic算法部分有时间会出一个实现教程。

具体实现框图如下
![screenShot.png](https://i.loli.net/2021/03/19/U4eoQvIMXS58GAP.png)

具体代码实现见开头源码链接。

#### 数字滤波器实现

1. 打开MATLAB的滤波器设计界面
    ![screenShot.png](https://i.loli.net/2021/03/19/4ijJFgZQf7BrPEX.png)

2. 完成参数配置
   ![screenShot.png](https://i.loli.net/2021/03/19/ECfljW9bJ8m5cdq.png)
    参数配置有以下几点需要注意的：

    第一就是滤波器的选型，虽然IIR滤波器能以较低的阶数完成较好的滤波效果但是在MATLAB直接生成的代码一般来说是不能用的，因为量化部分很难设计，而且整体的运行速度相比于FIR没有较大的提升，所以在这里就直接建议选用FIR滤波器。

    第二点就是Fs的选取，按照常规经验该数值应取截止频率的10~15倍，在带通滤波器中按中心频率的10~15倍算
    【注】：受采样频率的限制数字滤波器不适合生成带通滤波器。

3. 配置量化参数
   ![screenShot.png](https://i.loli.net/2021/03/19/fOKelwQTtoWYLb8.png)
   量化参数有两个参数需要进行配置，一个是coefficient，还有一个是input/output

   【注】：其中coefficient量化位数建议和输入位数一直。

4. 选择选项Target->Generate HDL打开自动代码生成界面
   ![screenShot.png](https://i.loli.net/2021/03/19/pRZvi4msFeG97qW.png)


    选好语言，保存路径，乘法器的形式之后按下Generate即可生成滤波器代码。
    
    【注】：之后的滤波器都是这样设计，之后就不继续详细说明。

#### 模块拼接

按照之前的FPGA内部实现框图拼接写好的模块，在最后AM解调后就可得出最后一路语音信号，最后将两路语音信号送到PWM_DAC模块中输出即可。

到此就完成了这道题的最基础的设计。

----

### 发挥部分

本题的发挥部分重点就是解决载波漂移的问题，但是换一种思维来看可以看作在48.5MHz的重心频率上再一次FM调制了一个低频信号。

于是我们只需要将中频带通滤波器(即10.7MHz带通滤波器)的通带放宽，可以换成LC带通滤波器，但推荐的SFECV10M7CQ0C01-R0陶瓷滤波器的通带完全满足题目要求，之后再进行正常FM解调，将解调后的信号过低通数字滤波器滤出，就可以得到混有一个低频信其中一路音频信号，之后再在输出端口加一个RC高通滤波器即可滤除混有的低频信号，从而得到一个干净的音频信号。

【注】：仅为猜想暂未证实。